{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="row" style="justify-content: space-between; align-items:center;">
    <div>
      <h3 class="title">Pelunasan Piutang</h3>
      <p class="subtitle">Input pembayaran ‚Üí jurnal otomatis: Kas/Bank (D) / Piutang (K)</p>
    </div>
    <a class="btn btn-ghost" href="{{ url_for('main.dashboard') }}">üèÅ Dashboard</a>
  </div>
</div>

<div class="spacer"></div>

<div class="card">
  <h3 class="title">Input Pembayaran</h3>
  <hr class="sep">

  <form method="post" class="form-grid">
    <div class="col-4">
      <label class="subtitle">Tanggal</label>
      <input class="input" type="date" name="date" value="{{ today }}" required>
    </div>

    <div class="col-4">
      <label class="subtitle">Pilih Invoice (Belum Lunas)</label>
      <select class="input" name="invoice_id" required>
        <option value="">-</option>
        {% for inv in open_invoices %}
          <option value="{{ inv.id }}">{{ inv.invoice_no }} ‚Ä¢ {{ inv.customer_name }}</option>
        {% endfor %}
      </select>
      <p class="muted" style="margin-top:6px;">
        (Kalau invoice sudah dihapus, list ini harusnya tidak ada lagi.)
      </p>
    </div>

    <div class="col-4">
      <label class="subtitle">Akun Kas/Bank</label>
      <select class="input" name="cash_account" required>
        <option value="">- pilih kas/bank -</option>
        {% for a in cash_accounts %}
          <option value="{{ a.code }}">{{ a.code }} - {{ a.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-4">
      <label class="subtitle">Nominal</label>
      <input class="input" type="number" step="0.01" name="amount" required>
    </div>

    <div class="col-8">
      <label class="subtitle">Catatan (opsional)</label>
      <input class="input" type="text" name="memo" placeholder="keterangan">
    </div>

    <div class="col-12 row" style="gap:10px;">
      <button class="btn btn-primary" type="submit">Simpan Pembayaran</button>
    </div>
  </form>
</div>

<div class="spacer"></div>

<div class="card">
  <h3 class="title">Riwayat Pembayaran (Terbaru)</h3>
  <hr class="sep">

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Invoice</th>
          <th>Kas/Bank</th>
          <th style="text-align:right;">Nominal</th>
          <th style="width:200px;"></th>
        </tr>
      </thead>
      <tbody>
        {% for pay in payments %}
        <tr>
          <td>{{ pay.date.date() if pay.date else "-" }}</td>
          <td>{{ pay.invoice_no or "-" }}</td>
          <td>{{ pay.cash_account_name or "-" }}</td>
          <td style="text-align:right;">Rp {{ "{:,.0f}".format(pay.amount or 0) }}</td>
          <td style="text-align:right;">
            <a class="btn btn-ghost" href="{{ url_for('main.ar_settlement_edit', payment_id=pay.id) }}">Edit</a>

            <form method="post"
                  action="{{ url_for('main.ar_settlement_delete', payment_id=pay.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('Hapus pembayaran piutang ini?');">
              <button class="btn btn-danger" type="submit">Hapus</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="muted">Belum ada pembayaran.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
