{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="row" style="justify-content: space-between; align-items:center;">
    <div>
      <h3 class="title">Pelunasan Piutang</h3>
      <p class="subtitle">Input pembayaran ‚Üí jurnal otomatis: Kas/Bank (D) / Piutang (K)</p>
    </div>
    <a class="btn btn-ghost" href="{{ url_for('main.dashboard') }}">üèÅ Dashboard</a>
  </div>

  <hr class="sep">

  <!-- FORM INPUT -->
  <form method="post" class="form-grid">
    <div class="col-4">
      <label class="subtitle">Tanggal</label>
      <input class="input" type="date" name="date" value="{{ today or '' }}" required>
    </div>

    <div class="col-4">
      <label class="subtitle">Pilih Invoice (Belum Lunas)</label>
      <select class="input" name="invoice_id" required>
        <option value="">- pilih -</option>
        {% for inv in open_invoices %}
          {% set sisa = (inv.total_amount or 0) - (inv.paid_amount or 0) %}
          <option value="{{ inv.id }}">
            {{ inv.invoice_no }} ‚Äî {{ inv.customer_name or '-' }} (Sisa: Rp {{ "{:,.0f}".format(sisa) }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-4">
      <label class="subtitle">Akun Kas/Bank</label>
      <select class="input" name="cash_account" required>
        <option value="">- pilih kas/bank -</option>
        {% for a in cash_accounts %}
          <option value="{{ a.code }}">{{ a.code }} - {{ a.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-4">
      <label class="subtitle">Nominal</label>
      <input class="input" type="number" step="0.01" name="amount" placeholder="0" required>
    </div>

    <div class="col-8">
      <label class="subtitle">Catatan (opsional)</label>
      <input class="input" type="text" name="memo" placeholder="mis: pelunasan bertahap">
    </div>

    <div class="col-12 row" style="gap:10px;">
      <button class="btn btn-primary" type="submit">Simpan Pembayaran</button>
    </div>
  </form>
</div>

<div class="spacer"></div>

<!-- RIWAYAT -->
<div class="card">
  <h3 class="title">Riwayat Pembayaran (Terbaru)</h3>
  <hr class="sep">

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Invoice</th>
          <th>Kas/Bank</th>
          <th style="text-align:right;">Nominal</th>
          <th>Catatan</th>
          <th style="width:180px;"></th>
        </tr>
      </thead>

      <tbody>
        {% for pay in payments %}
          <tr>
            <td>{{ pay.date.date() if pay.date else "-" }}</td>
            <td>{{ pay.invoice_no or "-" }}</td>
            <td>{{ pay.cash_account_name or pay.cash_account_code or "-" }}</td>
            <td style="text-align:right;">Rp {{ "{:,.0f}".format(pay.amount or 0) }}</td>
            <td>{{ pay.memo or "-" }}</td>
            <td style="text-align:right; white-space:nowrap;">
              <!-- PENTING: paramnya pay_id (bukan payment_id) -->
              <a class="btn btn-ghost" href="{{ url_for('main.ar_payment_edit', pay_id=pay.id) }}">Edit</a>

              <form method="post"
                    action="{{ url_for('main.ar_payment_delete', pay_id=pay.id) }}"
                    style="display:inline;"
                    onsubmit="return confirm('Hapus pembayaran piutang ini?');">
                <button class="btn btn-danger" type="submit">Hapus</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="muted">Belum ada data pembayaran piutang.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
