@bp.get("/reports/balance-sheet")
def report_balance_sheet():
    acc = _require_access()
    if not acc:
        return redirect(url_for("main.enter_code"))

    as_of_str = (request.args.get("as_of") or "").strip()
    as_of_date = _parse_ymd(as_of_str) or datetime.utcnow().date()
    to_dt_excl = datetime.combine(as_of_date + timedelta(days=1), datetime.min.time())

    def bal_upto(code: str) -> float:
        fk = _jl_entry_fk()
        q = (
            JournalLine.query.join(JournalEntry, fk == JournalEntry.id)
            .filter(
                JournalLine.access_code_id == acc.id,
                JournalLine.account_code == code,
                JournalEntry.access_code_id == acc.id,
                JournalEntry.date < to_dt_excl,
            )
        )
        debit = (
            q.with_entities(db.func.coalesce(db.func.sum(JournalLine.debit), 0.0)).scalar()
            or 0.0
        )
        credit = (
            q.with_entities(db.func.coalesce(db.func.sum(JournalLine.credit), 0.0)).scalar()
            or 0.0
        )
        return float(debit) - float(credit)

    assets = (
        Account.query.filter_by(access_code_id=acc.id)
        .filter(
            Account.type.in_(
                [
                    "Kas & Bank",
                    "Akun Piutang",
                    "Aktiva Lancar Lain",
                    "Persediaan",
                    "Aktiva Tetap",
                    "Akum. Peny.",
                ]
            )
        )
        .order_by(Account.code.asc())
        .all()
    )

    liabilities = (
        Account.query.filter_by(access_code_id=acc.id)
        .filter(Account.type.in_(["Akun Hutang", "Hutang Lancar Lain", "Hutang Jk. Panjang"]))
        .order_by(Account.code.asc())
        .all()
    )

    equities = (
        Account.query.filter_by(access_code_id=acc.id)
        .filter(Account.type == "Ekuitas")
        .order_by(Account.code.asc())
        .all()
    )

    asset_data = []
    liab_data = []
    eq_data = []

    total_assets = 0.0
    total_liab = 0.0
    total_eq = 0.0

    # ASET (normal debit)
    for a in assets:
        amt = float(bal_upto(a.code))
        if amt != 0:
            asset_data.append((a, amt))
            total_assets += amt

    # LIABILITAS (normal kredit -> tampilkan positif)
    for a in liabilities:
        amt = -float(bal_upto(a.code))
        if amt != 0:
            liab_data.append((a, amt))
            total_liab += amt

    # EKUITAS (normal kredit -> tampilkan positif)
    for a in equities:
        amt = -float(bal_upto(a.code))
        if amt != 0:
            eq_data.append((a, amt))
            total_eq += amt

    # NET PROFIT sampai as_of
    rev_accounts = Account.query.filter_by(access_code_id=acc.id, type="Pendapatan").all()
    rev_other_accounts = Account.query.filter_by(access_code_id=acc.id, type="Pendapatan Lain").all()
    hpp_accounts = Account.query.filter_by(access_code_id=acc.id, type="HPP").all()
    exp_accounts = Account.query.filter_by(access_code_id=acc.id, type="Beban").all()
    exp_other_accounts = Account.query.filter_by(access_code_id=acc.id, type="Beban Lain").all()

    sum_rev = sum(float(bal_upto(a.code)) for a in rev_accounts)
    sum_rev_other = sum(float(bal_upto(a.code)) for a in rev_other_accounts)
    sum_hpp = sum(float(bal_upto(a.code)) for a in hpp_accounts)
    sum_exp = sum(float(bal_upto(a.code)) for a in exp_accounts)
    sum_exp_other = sum(float(bal_upto(a.code)) for a in exp_other_accounts)

    net_profit = (-sum_rev - sum_rev_other) - (sum_hpp + sum_exp + sum_exp_other)

    if net_profit != 0:
        tmp = type("Tmp", (), {})()
        tmp.name = "Laba (Rugi) Sampai Tanggal Ini"
        eq_data.append((tmp, float(net_profit)))
        total_eq += float(net_profit)

    diff = float(total_assets) - float(total_liab + total_eq)

    return render_template(
        "report_balance_sheet.html",
        as_of=as_of_date.strftime("%Y-%m-%d"),
        as_of_display=as_of_date.strftime("%d %b %Y"),
        asset_data=asset_data,
        liab_data=liab_data,
        eq_data=eq_data,
        total_assets=total_assets,
        total_liab=total_liab,
        total_eq=total_eq,
        diff=diff,
    )
